<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
		<meta http-equiv="X-UA-Compatible" content="IE=9"/>
		<meta name="generator" content="Doxygen 1.11.0"/>
		<meta name="viewport" content="width=device-width, initial-scale=1"/>
		<title>BMSNode: BMSNode Blink Codes</title>
		<link href="tabs.css" rel="stylesheet" type="text/css"/>
		<script type="text/javascript" src="jquery.js"></script>
		<script type="text/javascript" src="dynsections.js"></script>
		<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
		<link href="doxygen.css" rel="stylesheet" type="text/css" />
		<link href="custom.css" rel="stylesheet" type="text/css"/>
<link href="custom_dark_theme.css" rel="stylesheet" type="text/css"/>
	</head>
	<body>
	<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
		<div id="titlearea">
			<table cellspacing="0" cellpadding="0">
				<tbody>
					<tr style="height: 56px;">
						<td id="projectalign" style="padding-left: 0.5em;">
							<div id="projectname">BMSNode
							</div>
							<div id="projectbrief">BMS Node Cell Monitoring Firmware</div>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
		<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md__2_users_2joe_2_documents_2_projects_2tronics_2emiata_2bms_2bmsnode_2bmsnode__firmware_2doc_2blink-patterns.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">BMSNode Blink Codes</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>TODO: this document should be brought into a higher level app-level spec.</p>
<p>This is a placeholder document to keep track of the meanings of blink patterns as the firmware is developed.</p>
<h1><a class="anchor" id="autotoc_md29"></a>
Patterns</h1>
<h2>Green</h2>
<p>The green LED is used by the boot loader. It will be rapid blinking or solid during boot loader operations. The boot loader always starts first when a node is powered or reset, so you should see the green LED blink rapidly for a brief moment when the boot loader starts. It may remain dark for the remainder of the boot loader delay, or it may be blinking. The device runs the boot loader for 4 seconds.</p>
<p>The green LED is also used to identify a node by turning on for 1 second in response to a PING command.</p>
<p>The blue LED may be blinking or faintly on during boot loader operations and should be ignored.</p>
<h2>Blue</h2>
<p>The blue LED is controlled by the application and is used to communicated the state of the main apllication. The green LED is not used by the application except for the PING command.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Name   </th><th class="markdownTableHeadNone">Blink Pattern   </th><th class="markdownTableHeadNone">Meaning    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">START   </td><td class="markdownTableBodyNone">50 ms for 1 sec   </td><td class="markdownTableBodyNone">Main app has just started due to reset, or power on. Follows boot loader. No response to commands during this time.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ACTIVE   </td><td class="markdownTableBodyNone">200 ms for &gt;= 1 sec   </td><td class="markdownTableBodyNone">Handling serial bus activity or processing commands.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SHUNT   </td><td class="markdownTableBodyNone">800ms on 200ms off   </td><td class="markdownTableBodyNone">Operating in shunt mode    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">TESTMODE   </td><td class="markdownTableBodyNone">200ms on 800ms off   </td><td class="markdownTableBodyNone">Operating in test mode    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">DFUWAKE   </td><td class="markdownTableBodyNone">1 s for 8 seconds   </td><td class="markdownTableBodyNone">DFU wake. Node stay awake for 8 seconds to relay DFU messages.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">SLEEP   </td><td class="markdownTableBodyNone">OFF   </td><td class="markdownTableBodyNone">Sleeping, in power saving mode.   </td></tr>
</table>
<h2>Red</h2>
<p>The red LED is controlled by the resistive load circuit. It turns on whenever the resistive shunt load is turned on, and likewise off. It cannot be controlled independently. Therefore, the red LED provides a visual indicator of the state of shunting.</p>
<p>If the shunt load is using PWM, then the red LED may appear dim.</p>
<h1><a class="anchor" id="autotoc_md30"></a>
State Transitions</h1>
<p>TODO: integrate this information into a comprehensive design document.</p>
<p>The following section is an abstraction to explain the sleep/wake operation of BMS Node. It does not reflect the actual internal state machine implementation.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">PS   </th><th class="markdownTableHeadNone">NS   </th><th class="markdownTableHeadNone">Transition    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">off   </td><td class="markdownTableBodyNone">START   </td><td class="markdownTableBodyNone">Node is powered on or reset, or started from boot loader    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">START   </td><td class="markdownTableBodyNone">ACTIVE   </td><td class="markdownTableBodyNone">1 seconds delay    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ACTIVE   </td><td class="markdownTableBodyNone">SLEEP   </td><td class="markdownTableBodyNone">no bus activity or commands in process for 1 seconds    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ACTIVE   </td><td class="markdownTableBodyNone">DFUWAKE   </td><td class="markdownTableBodyNone">any DFU command on the bus    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">SLEEP   </td><td class="markdownTableBodyNone">ACTIVE   </td><td class="markdownTableBodyNone">bus activity    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">DFUWAKE   </td><td class="markdownTableBodyNone">ACTIVE   </td><td class="markdownTableBodyNone">8 seconds delay   </td></tr>
</table>
<h2>Powering On/START</h2>
<p>Upon being first powered, or hardware reset, the boot loader runs for 4 seconds. At the start of this time the green LED will blink rapidly for a brief amount of time. After that it may remain on or off. (current bootloader leaves it off, old bootloader leaves it on).</p>
<p>After the boot loader is finished, the app will start. It will blink the blue LED rapidly for 1 second while it is initializing, and cannot process any commands during this time.</p>
<p>If a DFU update is performed (loading new firmware via boot loader), at the end of the update process the boot loader will start the (new) firmware and the 1 second blue LED blink pattern will occur.</p>
<p>The above implies that it will take 5 seconds from power on or reset before a node will respond to commands.</p>
<h2>START</h2>
<p>START always lasts 1 second with rapid blinking blue LED and then it will unconditionally transition to ACTIVE state.</p>
<h2>ACTIVE</h2>
<p>The firmware remains in active state for as long as there is any activity detected on the serial bus, or if there is any command currently being processed.</p>
<p>The blue LED blinks at 200 ms in this state.</p>
<p>After 1 seconds of no activity, the firmware will transition to the SLEEP state.</p>
<p>If during active state a DFU command is observed on the serial bus (addressed to any node), the firmware will transition to the DFUWAKE state.</p>
<h2>DFUWAKE</h2>
<p>This state is essentially the same as ACTIVE state, except that it will remain in this state for 8 seconds. This is a legacy state that was needed for the original hardware design.</p>
<p>The original purpose of this state was to ensure that all nodes remain active long enough for the DFU process to start up. This was because the DFU process can take several seconds to initiate and if a node goes to sleep during this time (after 1 second) then the DFU protocol will not be properly relayed by intermediate nodes.</p>
<p>Once DFU protocol is running, then there is enough bus activity to keep the node in the active state.</p>
<p>After 8 seconds the firmware will transition back to the ACTIVE state and remain there as long as there is any activity, including DFU protocol or routine commands.</p>
<p>The current hardware design does not require nodes to actively relay DFU protocol bytes and so this state is no longer needed. It remains for the moment on the chance that old hardware needs to be supported. It will eventually be removed.</p>
<p>The blue LED blinks with 1 second toggle in DFUWAKE state.</p>
<h2>SLEEP</h2>
<p>On entering this state, all IO is disabled and peripherals powered down. The MCU is placed in as low a power mode as possible. The low power mode is ended when any activity occurs on the serial bus, or the device has a hardware reset. When the MCU wakes due to serial activity, the firmware then re-enables the IO and powers up the peripherals and resumes running in the ACTIVE state. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
		<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
			<ul>
				<li class="footer">
					Generated on Wed Jan 22 2025 15:43:06 for BMSNode by <a href="http://www.doxygen.org/index.html">
					<img class="footer" src="doxygen.png" alt="doxygen"
                     onerror="this.onerror=null;this.src='doxygen.svg';"/></a> 1.11.0.
					Dark theme by <a href="http://majerle.eu" target="_new">Tilen Majerle</a>. All rights reserved.
				</li>
			</ul>
		</div>
		<script src="custom.js"></script>
	</body>
</html>
